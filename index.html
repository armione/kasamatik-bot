<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kasamatik — Supabase Tam Entegre</title>

  <!-- Tailwind, Chart.js, Supabase -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Basit favori stil: dosya uzun, ama görünüm usable */
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#0b1020; color:#e6eef8; }
    .glass { background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.06); border-radius:12px; padding:14px; }
    .btn { padding:8px 12px; border-radius:8px; cursor:pointer; }
    .btn-primary { background:linear-gradient(90deg,#60a5fa,#7c3aed); color:white; border:none; }
    .btn-danger { background:#ef4444; color:white; border:none; }
    .input { background:white; color:black; border-radius:6px; padding:8px; border:1px solid #ddd; }
    .hidden { display:none; }
    .sidebar { width:260px; position:fixed; left:20px; top:20px; bottom:20px; padding:16px; }
    .main { margin-left:320px; padding:24px; }
    .small { font-size:0.85rem; color:#9fb0d8; }
    .badge { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:rgba(255,255,255,0.06); }
  </style>
</head>
<body>

  <!-- ---------- AUTH UI ---------- -->
  <div id="auth-container" class="min-h-screen flex items-center justify-center p-6">
    <div class="glass w-full max-w-md">
      <h1 class="text-2xl font-semibold mb-4">Kasamatik — Giriş</h1>
      <div class="mb-3">
        <label class="small">E-posta</label>
        <input id="email" class="input w-full" type="email" placeholder="ornek@mail.com" />
      </div>
      <div class="mb-3">
        <label class="small">Şifre</label>
        <input id="password" class="input w-full" type="password" placeholder="••••••••" />
      </div>
      <div class="flex gap-2">
        <button id="login-btn" class="btn btn-primary flex-1">Giriş Yap</button>
        <button id="signup-btn" class="btn bg-gray-700">Kayıt Ol</button>
      </div>
      <p id="auth-note" class="small mt-3">Henüz hesabın yoksa kayıt ol. E-posta doğrulaması kullanıyorsan gelen kutunu kontrol et.</p>
    </div>
  </div>

  <!-- ---------- APP UI ---------- -->
  <div id="app-container" class="hidden">
    <div class="sidebar glass">
      <div class="mb-4">
        <h2 class="text-lg font-semibold">Kasamatik</h2>
        <div id="user-email" class="small mt-1"></div>
      </div>

      <nav class="space-y-2 mb-4">
        <button class="btn w-full text-left" data-section="dashboard">🏠 Ana Panel</button>
        <button class="btn w-full text-left" data-section="new-bet">➕ Yeni Kayıt</button>
        <button class="btn w-full text-left" data-section="history">📋 Bahis Geçmişi</button>
        <button class="btn w-full text-left" data-section="cash-history">💰 Kasa</button>
        <button class="btn w-full text-left" data-section="statistics">📊 İstatistikler</button>
        <button class="btn w-full text-left" data-section="settings">⚙️ Ayarlar</button>
      </nav>

      <div class="mt-auto space-y-2">
        <button id="logout-btn" class="btn btn-danger w-full">Çıkış Yap</button>
        <div class="small mt-2">v2.1 - Supabase</div>
      </div>
    </div>

    <div class="main">
      <div id="notifications" class="mb-4"></div>

      <!-- Dashboard -->
      <section id="dashboard" class="page-section">
        <div class="glass mb-4">
          <div class="flex justify-between items-center">
            <h3 class="text-xl font-semibold">📋 Özet</h3>
            <div>
              <span class="badge" id="total-bankroll">Kasada: 0 ₺</span>
              <span class="badge" id="total-bets-count">Bahis: 0</span>
            </div>
          </div>
          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="glass">
              <h4 class="font-semibold">📈 Kar / Zarar (Grafik)</h4>
              <canvas id="profitChart" style="max-height:220px;"></canvas>
            </div>
            <div class="glass">
              <h4 class="font-semibold">🧩 Platform Dağılımı</h4>
              <canvas id="platformChart" style="max-height:220px;"></canvas>
            </div>
          </div>
        </div>

        <div class="glass">
          <h4 class="font-semibold mb-2">⚡ Son Bahisler</h4>
          <div id="recent-bets" class="space-y-2"></div>
        </div>
      </section>

      <!-- New bet -->
      <section id="new-bet" class="page-section hidden">
        <div class="glass mb-4">
          <h3 class="text-xl font-semibold">➕ Yeni Bahis Kaydı</h3>

          <form id="bet-form" class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="md:col-span-2">
              <label class="small">Platform</label>
              <div class="flex gap-2">
                <select id="platform" class="input flex-1"></select>
                <button id="platform-manager-btn" type="button" class="btn bg-gray-700">⚙️</button>
              </div>
            </div>

            <div>
              <label class="small">Tür</label>
              <select id="bet-type" class="input">
                <option value="Spor Bahis">Spor Bahis</option>
                <option value="Canlı Bahis">Canlı Bahis</option>
                <option value="Casino">Casino</option>
                <option value="Slot">Slot</option>
              </select>
            </div>

            <div class="md:col-span-2">
              <label class="small">Açıklama</label>
              <input id="description" class="input w-full" placeholder="Galatasaray - Fenerbahçe (1)" />
            </div>

            <div>
              <label class="small">Miktar (₺)</label>
              <input id="bet-amount" class="input" type="number" step="0.01" />
            </div>

            <div>
              <label class="small">Oran</label>
              <input id="odds" class="input" type="number" step="0.01" />
            </div>

            <div>
              <label class="small">Tarih</label>
              <input id="bet-date" class="input" type="date" />
            </div>

            <div class="md:col-span-3">
              <label class="small">Kupon Resmi (Opsiyonel)</label>
              <div id="image-upload-area" class="glass p-3 text-center">
                <p class="small mb-2">Resmi sürükle / yapıştır veya dosya seç</p>
                <input id="image-input" type="file" accept="image/*" class="hidden" />
                <button id="image-select-btn" type="button" class="btn btn-primary">Dosya Seç</button>
                <div id="image-preview" class="mt-2 hidden">
                  <img id="preview-img" style="max-width:100%;max-height:140px;border-radius:8px;" />
                  <div class="mt-2 flex gap-2 justify-center">
                    <button id="remove-image-btn" type="button" class="btn bg-red-600">Kaldır</button>
                    <button id="gemini-analyze-btn" type="button" class="btn btn-primary" disabled>
                      ✨ Kuponu Oku & Analiz Et
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="md:col-span-3 flex justify-end gap-2 mt-2">
              <button id="reset-form-btn" type="button" class="btn bg-gray-700">Temizle</button>
              <button type="submit" class="btn btn-primary">Bahis Ekle</button>
            </div>
          </form>
        </div>
      </section>

      <!-- History -->
      <section id="history" class="page-section hidden">
        <div class="glass mb-4">
          <div class="flex justify-between items-center">
            <h3 class="text-xl font-semibold">📋 Bahis Geçmişi</h3>
            <div class="flex gap-2 items-center">
              <select id="status-filter" class="input">
                <option value="all">Tümü</option>
                <option value="pending">Bekleyen</option>
                <option value="won">Kazanan</option>
                <option value="lost">Kaybeden</option>
              </select>
              <button id="clear-all-btn" class="btn bg-red-600">🗑️ Tüm Verileri Temizle</button>
            </div>
          </div>

          <div id="bet-history" class="mt-3 space-y-2"></div>
          <div id="pagination" class="mt-4 flex gap-2"></div>
        </div>
      </section>

      <!-- Cash history -->
      <section id="cash-history" class="page-section hidden">
        <div class="glass mb-4">
          <h3 class="text-xl font-semibold">💰 Kasa İşlemleri</h3>

          <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="small">Miktar (₺)</label>
              <input id="cash-amount" class="input" type="number" step="0.01" />
            </div>
            <div>
              <label class="small">İşlem Türü</label>
              <select id="cash-type" class="input">
                <option value="deposit">Yatırma</option>
                <option value="withdrawal">Çekim</option>
              </select>
            </div>
            <div class="flex items-end gap-2">
              <button id="cash-deposit-btn" class="btn btn-primary">Uygula</button>
              <button id="reset-bankroll-btn" class="btn bg-gray-700">Kasayı Sıfırla</button>
            </div>
          </div>

          <div class="mt-4">
            <h4 class="font-semibold">İşlem Geçmişi</h4>
            <div id="cash-history-list" class="mt-2 space-y-2"></div>
          </div>
        </div>
      </section>

      <!-- Statistics -->
      <section id="statistics" class="page-section hidden">
        <div class="glass">
          <h3 class="text-xl font-semibold">📊 İstatistikler</h3>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="glass p-3">
              <div class="small">Toplam Bahis</div>
              <div id="stats-total-bets" class="text-lg font-bold">0</div>
            </div>
            <div class="glass p-3">
              <div class="small">Kazanma Oranı</div>
              <div id="stats-win-rate" class="text-lg font-bold">0%</div>
            </div>
            <div class="glass p-3">
              <div class="small">ROI</div>
              <div id="stats-roi" class="text-lg font-bold">0%</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Settings -->
      <section id="settings" class="page-section hidden">
        <div class="glass">
          <h3 class="text-xl font-semibold">⚙️ Ayarlar & Platform Yönetimi</h3>

          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="small">Yeni Platform</label>
              <div class="flex gap-2">
                <input id="new-platform-name" class="input" placeholder="Platform adı" />
                <button id="add-platform-btn" class="btn btn-primary">➕</button>
              </div>
              <div id="custom-platforms-list" class="mt-3 space-y-2"></div>
            </div>

            <div>
              <label class="small">Veri Yönetimi</label>
              <div class="flex flex-col gap-2 mt-2">
                <button id="export-btn" class="btn btn-primary">📤 Dışa Aktar JSON</button>
                <button id="import-btn" class="btn bg-gray-700">📥 İçe Aktar JSON</button>
                <input id="import-file" type="file" accept=".json" class="hidden" />
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- ---------- SCRIPTS ---------- -->
  <script>
  (async function() {
    // ---------- CONFIG ----------
    // Trying to be "drop-in": load config from a few possible places.
    let SUPABASE_URL = null;
    let SUPABASE_ANON_KEY = null;

    // 1) window.SUPABASE_CONFIG (if your hosting injects)
    if (window.SUPABASE_CONFIG && window.SUPABASE_CONFIG.url) {
      SUPABASE_URL = window.SUPABASE_CONFIG.url;
      SUPABASE_ANON_KEY = window.SUPABASE_CONFIG.anonKey;
    }

    // 2) localStorage fallback (if you stored earlier)
    if (!SUPABASE_URL) SUPABASE_URL = localStorage.getItem('SUPABASE_URL');
    if (!SUPABASE_ANON_KEY) SUPABASE_ANON_KEY = localStorage.getItem('SUPABASE_ANON_KEY');

    // 3) Inline placeholders (edit only if necessary)
    if (!SUPABASE_URL) SUPABASE_URL = "https://huaelrdjrcoljkkprewz.supabase.co"; // e.g. https://xxxxx.supabase.co
    if (!SUPABASE_ANON_KEY) SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1YWVscmRqcmNvbGpra3ByZXd6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NDI4ODMsImV4cCI6MjA3MjQxODg4M30.kYcxJtT9qQ8rMcNUD2Dy7W8kgYBK9c9xRUVUthJV2Qg";

    // If placeholders remain, show notification (still file will load but Supabase ops will fail)
    const SHOW_SUPABASE_WARNING = SUPABASE_URL.includes("PUT_YOUR") || SUPABASE_ANON_KEY.includes("PUT_YOUR");

    // Initialize Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------- DOM refs ----------
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('login-btn');
    const signupBtn = document.getElementById('signup-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userEmail = document.getElementById('user-email');
    const notifications = document.getElementById('notifications');

    // Sections & lists
    const sections = document.querySelectorAll('.page-section');
    const sidebarButtons = document.querySelectorAll('.sidebar button[data-section]');

    // New bet elements
    const betForm = document.getElementById('bet-form');
    const platformSelect = document.getElementById('platform');
    const descriptionInput = document.getElementById('description');
    const amountInput = document.getElementById('bet-amount');
    const oddsInput = document.getElementById('odds');
    const dateInput = document.getElementById('bet-date');
    const imageInput = document.getElementById('image-input');
    const imageSelectBtn = document.getElementById('image-select-btn');
    const imagePreview = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');
    const removeImageBtn = document.getElementById('remove-image-btn');
    const geminiBtn = document.getElementById('gemini-analyze-btn');

    // History
    const betHistoryEl = document.getElementById('bet-history');
    const statusFilter = document.getElementById('status-filter');
    const paginationEl = document.getElementById('pagination');

    // Cash
    const cashAmount = document.getElementById('cash-amount');
    const cashType = document.getElementById('cash-type');
    const cashDepositBtn = document.getElementById('cash-deposit-btn');
    const cashHistoryList = document.getElementById('cash-history-list');
    const resetBankrollBtn = document.getElementById('reset-bankroll-btn');

    // Settings
    const newPlatformInput = document.getElementById('new-platform-name');
    const addPlatformBtn = document.getElementById('add-platform-btn');
    const customPlatformsList = document.getElementById('custom-platforms-list');
    const exportBtn = document.getElementById('export-btn');
    const importBtn = document.getElementById('import-btn');
    const importFileInput = document.getElementById('import-file');
    
    // Dashboard smalls
    const totalBankrollBadge = document.getElementById('total-bankroll');
    const totalBetsCount = document.getElementById('total-bets-count');
    const recentBetsEl = document.getElementById('recent-bets');

    // Charts
    let profitChart = null;
    let platformChart = null;

    // State
    let currentUser = null;
    let bets = []; // cached bets
    let platforms = []; // cached platforms
    let cashHistory = []; // cached cash history (fallback localStorage)
    let itemsPerPage = 8;
    let currentPage = 1;

    // Utility: notifications
    function showNotification(msg, type = 'info', timeout = 3500) {
      const div = document.createElement('div');
      div.className = 'glass p-3 mb-2';
      div.style.borderLeft = type === 'error' ? '4px solid #ef4444' : '4px solid #60a5fa';
      div.innerText = msg;
      notifications.appendChild(div);
      setTimeout(() => div.remove(), timeout);
    }

    if (SHOW_SUPABASE_WARNING) {
      showNotification('Supabase URL veya ANON KEY placeholder durumda. Eğer zaten deploy ortamında set edildiyse bu uyarıyı göz ardı edebilirsin.', 'info', 8000);
    }

    // ---------- AUTH ----------
    loginBtn.addEventListener('click', async () => {
      loginBtn.disabled = true;
      try {
        const email = emailInput.value.trim();
        const password = passwordInput.value;
        if (!email || !password) { showNotification('Email ve şifre gerekli', 'error'); return; }
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) { showNotification('Giriş hatası: ' + error.message, 'error'); }
        else { showNotification('Giriş başarılı', 'success'); await checkUser(); }
      } finally { loginBtn.disabled = false; }
    });

    signupBtn.addEventListener('click', async () => {
      signupBtn.disabled = true;
      try {
        const email = emailInput.value.trim();
        const password = passwordInput.value;
        if (!email || !password) { showNotification('Email ve şifre gerekli', 'error'); return; }
        const { data, error } = await supabase.auth.signUp({ email, password });
        if (error) { showNotification('Kayıt hatası: ' + error.message, 'error'); }
        else { showNotification('Kayıt başarılı. E-posta doğrulaması gerekiyorsa kontrol et.', 'success'); }
      } finally { signupBtn.disabled = false; }
    });

    logoutBtn.addEventListener('click', async () => {
      const { error } = await supabase.auth.signOut();
      if (error) showNotification('Çıkış hatası: ' + error.message, 'error');
      else showNotification('Çıkış yapıldı', 'info');
    });

    supabase.auth.onAuthStateChange((event, session) => {
      checkUser(); // keep UI in sync
    });

    async function checkUser() {
      const { data } = await supabase.auth.getUser();
      currentUser = data?.user || null;
      if (currentUser) {
        authContainer.classList.add('hidden');
        appContainer.classList.remove('hidden');
        userEmail.innerText = currentUser.email;
        await initApp();
      } else {
        authContainer.classList.remove('hidden');
        appContainer.classList.add('hidden');
      }
    }

    // ---------- INIT APP ----------
    async function initApp() {
      // load necessary data and setup UI
      await loadPlatforms();
      await loadBets();
      await loadCashHistory();
      renderPlatformOptions();
      renderCustomPlatformsList();
      updateAllStatsAndUI();
      setupEventBindings(); // only once
      // open dashboard by default
      showSection('dashboard');
    }

    // ---------- SECTION NAV ----------
    function showSection(sectionId) {
      sections.forEach(s => s.id === sectionId ? s.classList.remove('hidden') : s.classList.add('hidden'));
      // highlight sidebar button
      sidebarButtons.forEach(b => b.dataset.section === sectionId ? b.classList.add('bg-gray-800') : b.classList.remove('bg-gray-800'));
      // re-render charts if needed
      if (sectionId === 'statistics' || sectionId === 'dashboard') updateCharts();
    }
    sidebarButtons.forEach(btn => btn.addEventListener('click', () => showSection(btn.dataset.section)));

    // ---------- PLATFORMS ----------
    async function loadPlatforms() {
      try {
        const { data, error } = await supabase.from('platforms').select('id,name').order('name', { ascending: true });
        if (error) throw error;
        platforms = data || [];
        // include default platforms if none exist
        if (platforms.length === 0) {
          const defaults = ["Bilyoner", "Misli", "Nesine", "Tuttur"];
          for (const p of defaults) {
            await supabase.from('platforms').insert({ name: p }).select();
          }
          const res = await supabase.from('platforms').select('id,name').order('name',{ascending:true});
          platforms = res.data || [];
        }
      } catch (err) {
        console.error(err);
        showNotification('Platformlar yüklenemedi, local fallback kullanılıyor', 'error');
        // fallback to some defaults
        platforms = [{ id: 'bily', name: 'Bilyoner' }, { id: 'mis', name: 'Misli' }];
      }
    }

    function renderPlatformOptions() {
      platformSelect.innerHTML = '<option value="">Platform Seçin</option>';
      const quickPlatform = document.getElementById('quick-platform');
      if (quickPlatform) quickPlatform.innerHTML = '<option value="">Platform Seçin</option>';
      platforms.forEach(p => {
        const opt = document.createElement('option'); opt.value = p.name; opt.innerText = p.name;
        platformSelect.appendChild(opt);
      });
    }

    async function addCustomPlatform(fromInput=true) {
      const name = (fromInput ? newPlatformInput.value : document.getElementById('new-platform-name-modal')?.value)?.trim();
      if (!name) { showNotification('Platform adı boş olamaz', 'error'); return; }
      try {
        const { data, error } = await supabase.from('platforms').insert({ name }).select();
        if (error) throw error;
        await loadPlatforms();
        renderPlatformOptions();
        renderCustomPlatformsList();
        newPlatformInput.value = '';
        showNotification('Platform eklendi', 'success');
      } catch (err) {
        console.error(err);
        showNotification('Platform eklenemedi: ' + (err.message || err), 'error');
      }
    }

    addPlatformBtn.addEventListener('click', () => addCustomPlatform(true));

    function renderCustomPlatformsList() {
      customPlatformsList.innerHTML = '';
      platforms.forEach(p => {
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center';
        div.innerHTML = `<div>${p.name}</div><div><button class="btn bg-red-600 btn-del-platform" data-id="${p.id}">Sil</button></div>`;
        customPlatformsList.appendChild(div);
      });
      document.querySelectorAll('.btn-del-platform').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          if (!confirm('Platform silinsin mi?')) return;
          const { error } = await supabase.from('platforms').delete().eq('id', id);
          if (error) showNotification('Platform silinemedi: ' + error.message, 'error');
          else { showNotification('Platform silindi', 'success'); await loadPlatforms(); renderPlatformOptions(); renderCustomPlatformsList(); }
        });
      });
    }

    // ---------- BETS CRUD ----------
    async function loadBets() {
      try {
        const { data, error } = await supabase
          .from('bets')
          .select('*')
          .order('created_at', { ascending: false });
        if (error) throw error;
        bets = data || [];
      } catch (err) {
        console.error(err);
        showNotification('Bahisler yüklenemedi. Local fallback uygulanıyor.', 'error');
        // fallback to localStorage
        const ls = localStorage.getItem('bets');
        bets = ls ? JSON.parse(ls) : [];
      }
    }

    async function addBetToDB(betObj) {
      try {
        const { data, error } = await supabase.from('bets').insert(betObj).select();
        if (error) throw error;
        return data[0];
      } catch (err) {
        console.error(err);
        showNotification('Bahis eklenemedi: ' + err.message, 'error');
        return null;
      }
    }

    async function updateBetInDB(id, patch) {
      try {
        const { data, error } = await supabase.from('bets').update(patch).eq('id', id).select();
        if (error) throw error;
        return data[0];
      } catch (err) {
        console.error(err);
        showNotification('Güncelleme hatası: ' + err.message, 'error');
        return null;
      }
    }

    async function deleteBetFromDB(id) {
      try {
        const { error } = await supabase.from('bets').delete().eq('id', id);
        if (error) throw error;
        return true;
      } catch (err) {
        console.error(err);
        showNotification('Silme hatası: ' + err.message, 'error');
        return false;
      }
    }

    // FORM SUBMIT
    betForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const p = platformSelect.value || 'Unknown';
      const description = descriptionInput.value.trim();
      const amount = parseFloat(amountInput.value) || 0;
      const odds = parseFloat(oddsInput.value) || 1;
      const date = dateInput.value || new Date().toISOString().slice(0,10);

      if (!description) { showNotification('Açıklama gerekli', 'error'); return; }

      const newBet = {
        platform: p,
        description,
        amount,
        odds,
        date,
        status: 'pending',
        created_at: new Date().toISOString()
      };

      // If there's a preview image, include as base64 (small convenience) — better to upload to storage in production
      if (previewImg.src) newBet.image_base64 = previewImg.src;

      const inserted = await addBetToDB(newBet);
      if (inserted) {
        showNotification('Bahis eklendi', 'success');
        // refresh data
        await loadBets();
        updateAllStatsAndUI();
        betForm.reset();
        imagePreview.classList.add('hidden');
        previewImg.src = '';
      }
    });

    // RENDER HISTORY with pagination & filter
    function renderHistory() {
      const filter = statusFilter.value;
      let filtered = bets.slice();
      if (filter !== 'all') filtered = filtered.filter(b => (b.status||'pending') === filter);
      const total = filtered.length;
      const pages = Math.max(1, Math.ceil(total / itemsPerPage));
      if (currentPage > pages) currentPage = pages;
      const start = (currentPage - 1) * itemsPerPage;
      const pageItems = filtered.slice(start, start + itemsPerPage);

      betHistoryEl.innerHTML = '';
      pageItems.forEach(b => {
        const div = document.createElement('div');
        div.className = 'glass p-3 flex justify-between items-start';
        div.innerHTML = `
          <div style="max-width:70%">
            <div class="font-semibold">${escapeHtml(b.description || '')}</div>
            <div class="small">${b.platform || '-'} • ${b.date ? b.date.slice(0,10) : ''} • Oran: ${b.odds}</div>
            <div class="mt-2 small">Miktar: ${b.amount}₺ • Durum: ${(b.status||'pending')}</div>
          </div>
          <div class="flex flex-col gap-2">
            <button class="btn bg-gray-700 btn-edit" data-id="${b.id}">✏️</button>
            <button class="btn bg-red-600 btn-delete" data-id="${b.id}">🗑️</button>
            <select class="input small btn-change-status" data-id="${b.id}">
              <option value="pending" ${ (b.status||'pending')==='pending' ? 'selected' : '' }>Bekleyen</option>
              <option value="won" ${ b.status==='won' ? 'selected' : '' }>Kazandı</option>
              <option value="lost" ${ b.status==='lost' ? 'selected' : '' }>Kaybetti</option>
            </select>
          </div>
        `;
        betHistoryEl.appendChild(div);
      });

      // pagination
      paginationEl.innerHTML = '';
      for (let p=1;p<=pages;p++) {
        const pg = document.createElement('button');
        pg.className = 'btn small ' + (p===currentPage ? 'bg-gray-800' : 'bg-gray-700');
        pg.innerText = p;
        pg.addEventListener('click', () => { currentPage = p; renderHistory(); });
        paginationEl.appendChild(pg);
      }

      // bind edit/delete/status buttons
      document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          if (!confirm('Kaydı silmek istediğine emin misin?')) return;
          const ok = await deleteBetFromDB(id);
          if (ok) {
            await loadBets();
            renderHistory();
            updateAllStatsAndUI();
            showNotification('Kayıt silindi', 'success');
          }
        });
      });

      document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const bet = bets.find(x => String(x.id) === String(id));
          if (!bet) return;
          // populate form for quick edit (simple approach)
          platformSelect.value = bet.platform;
          descriptionInput.value = bet.description;
          amountInput.value = bet.amount;
          oddsInput.value = bet.odds;
          dateInput.value = bet.date ? bet.date.slice(0,10) : '';
          // scroll to new-bet
          showSection('new-bet');
          // Save: we'll attach a temporary update handler
          const saveHandler = async (e) => {
            e.preventDefault();
            const patch = {
              platform: platformSelect.value,
              description: descriptionInput.value,
              amount: parseFloat(amountInput.value) || 0,
              odds: parseFloat(oddsInput.value) || 1,
              date: dateInput.value || new Date().toISOString().slice(0,10)
            };
            const updated = await updateBetInDB(id, patch);
            if (updated) {
              showNotification('Güncellendi', 'success');
              await loadBets();
              updateAllStatsAndUI();
              betForm.removeEventListener('submit', saveHandler);
            }
          };
          betForm.addEventListener('submit', saveHandler);
        });
      });

      document.querySelectorAll('.btn-change-status').forEach(sel => {
        sel.addEventListener('change', async () => {
          const id = sel.dataset.id;
          const newStatus = sel.value;
          // if won, optionally compute win amount
          await updateBetInDB(id, { status: newStatus });
          await loadBets();
          updateAllStatsAndUI();
          renderHistory();
        });
      });
    }

    statusFilter.addEventListener('change', () => { currentPage = 1; renderHistory(); });

    // ---------- CASH HISTORY ----------
    // We'll attempt to use a 'cash_history' table. If not present, fallback to localStorage.
    let CASH_TABLE_AVAILABLE = true;
    async function loadCashHistory() {
      try {
        const { data, error } = await supabase.from('cash_history').select('*').order('created_at', { ascending: false });
        if (error) {
          // If error mentions relation cash_history does not exist, fallback
          CASH_TABLE_AVAILABLE = false;
          throw error;
        }
        cashHistory = data || [];
      } catch (err) {
        console.warn('cash_history table not available, fallback to localStorage', err);
        CASH_TABLE_AVAILABLE = false;
        const ls = localStorage.getItem('cash_history');
        cashHistory = ls ? JSON.parse(ls) : [];
      }
      renderCashHistory();
    }

    async function upsertCash(amount, type) {
      const entry = { amount: parseFloat(amount) || 0, type, created_at: new Date().toISOString() };
      if (CASH_TABLE_AVAILABLE) {
        try {
          const { data, error } = await supabase.from('cash_history').insert(entry).select();
          if (error) throw error;
          cashHistory.unshift(data[0]);
        } catch (err) {
          console.error(err);
          showNotification('Kasa işlemi başarısız: ' + err.message, 'error');
        }
      } else {
        cashHistory.unshift(entry);
        localStorage.setItem('cash_history', JSON.stringify(cashHistory));
      }
      renderCashHistory();
      updateAllStatsAndUI();
    }

    function renderCashHistory() {
      cashHistoryList.innerHTML = '';
      if (!cashHistory.length) {
        cashHistoryList.innerHTML = '<div class="small">Kayıt yok</div>';
        return;
      }
      cashHistory.forEach(c => {
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center glass p-2';
        div.innerHTML = `<div>${c.type === 'deposit' ? 'Yatırma' : 'Çekim'} • ${ (c.created_at||'').slice(0,10)}</div><div class="font-semibold">${c.amount} ₺</div>`;
        cashHistoryList.appendChild(div);
      });
      // update bankroll badge
      const net = cashHistory.reduce((acc, cur) => acc + (cur.type === 'deposit' ? +cur.amount : -cur.amount), 0);
      totalBankrollBadge.innerText = `Kasada: ${net.toFixed(2)} ₺`;
    }

    cashDepositBtn.addEventListener('click', async () => {
      const amount = parseFloat(cashAmount.value);
      const type = cashType.value;
      if (!amount || isNaN(amount)) { showNotification('Geçerli miktar girin', 'error'); return; }
      await upsertCash(amount, type);
      cashAmount.value = '';
    });

    resetBankrollBtn.addEventListener('click', async () => {
      if (!confirm('Kasa sıfırlansın mı? Bu geri alınamaz.')) return;
      // delete cash history on Supabase if table exists
      if (CASH_TABLE_AVAILABLE) {
        const { error } = await supabase.from('cash_history').delete().neq('id', 0);
        if (error) { showNotification('Kasayı sıfırlama hatası: ' + error.message, 'error'); return; }
      } else {
        localStorage.removeItem('cash_history');
      }
      cashHistory = [];
      renderCashHistory();
      showNotification('Kasa sıfırlandı', 'success');
      updateAllStatsAndUI();
    });

    // ---------- IMPORT / EXPORT ----------
    exportBtn.addEventListener('click', async () => {
      // gather data (bets + platforms + cash)
      const payload = { bets, platforms, cashHistory };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'kasamatik-export.json'; a.click();
      URL.revokeObjectURL(url);
      showNotification('Dışa aktarma hazırlandı', 'success');
    });

    importBtn.addEventListener('click', () => importFileInput.click());
    importFileInput.addEventListener('change', async (e) => {
      const f = e.target.files[0];
      if (!f) return;
      const txt = await f.text();
      try {
        const obj = JSON.parse(txt);
        // Merge or replace strategy: here merge by inserting bets/platforms if not present
        if (Array.isArray(obj.platforms)) {
          for (const p of obj.platforms) {
            // skip duplicates
            const exists = platforms.find(x => x.name === p.name);
            if (!exists) await supabase.from('platforms').insert({ name: p.name });
          }
          await loadPlatforms(); renderPlatformOptions();
        }
        if (Array.isArray(obj.bets)) {
          for (const b of obj.bets) {
            // naive insert - if you have unique constraints, handle carefully
            await supabase.from('bets').insert(b).select();
          }
          await loadBets(); renderHistory(); updateAllStatsAndUI();
        }
        if (Array.isArray(obj.cashHistory)) {
          if (CASH_TABLE_AVAILABLE) {
            for (const c of obj.cashHistory) await supabase.from('cash_history').insert(c).select();
            await loadCashHistory();
          } else {
            // merge to local
            cashHistory = [...obj.cashHistory, ...cashHistory];
            localStorage.setItem('cash_history', JSON.stringify(cashHistory));
            renderCashHistory();
          }
        }
        showNotification('İçe aktarma tamamlandı', 'success');
      } catch (err) {
        console.error(err);
        showNotification('İçe aktarma başarısız: ' + err.message, 'error');
      } finally {
        importFileInput.value = '';
      }
    });

    // ---------- CHARTS ----------
    function updateCharts() {
      try {
        // profitChart: total profit by month (sum of won amount - amount)
        const resolvedBets = bets.filter(b => b.status === 'won' || b.status === 'lost');
        const byMonth = {};
        resolvedBets.forEach(b => {
          const m = (b.created_at || b.date || new Date()).slice(0,7);
          if(!byMonth[m]) byMonth[m] = { profit:0 };
          if (b.status === 'won') {
            // if you store win_amount, use it; else approximate: amount * (odds - 1)
            const win = b.win_amount !== undefined ? +b.win_amount : (+(b.amount || 0) * ((+(b.odds||1))-1));
            byMonth[m].profit += win;
          } else {
            byMonth[m].profit -= +(b.amount||0);
          }
        });
        const labels = Object.keys(byMonth).sort();
        const dataProfit = labels.map(l => +byMonth[l].profit.toFixed(2));

        // platformChart
        const byPlatform = {};
        bets.forEach(b => {
          const p = b.platform || 'Diğer';
          if (!byPlatform[p]) byPlatform[p] = 0;
          byPlatform[p] += +(b.amount || 0);
        });
        const pLabels = Object.keys(byPlatform);
        const pData = pLabels.map(k => +byPlatform[k].toFixed(2));

        // create/update Chart.js charts
        if (!profitChart) {
          profitChart = new Chart(document.getElementById('profitChart'), {
            type: 'line',
            data: { labels, datasets: [{ label:'Profit', data: dataProfit, tension:0.3 }] },
            options: { responsive:true, plugins:{legend:{display:false}} }
          });
        } else {
          profitChart.data.labels = labels;
          profitChart.data.datasets[0].data = dataProfit;
          profitChart.update();
        }

        if (!platformChart) {
          platformChart = new Chart(document.getElementById('platformChart'), {
            type: 'pie',
            data: { labels: pLabels, datasets: [{ label:'Platform', data: pData }] },
            options: { responsive:true, plugins:{legend:{position:'bottom'}} }
          });
        } else {
          platformChart.data.labels = pLabels;
          platformChart.data.datasets[0].data = pData;
          platformChart.update();
        }

      } catch (err) {
        console.error('updateCharts error', err);
      }
    }

    // ---------- RECENT BETS + STATS ----------
    function renderRecentBets() {
      recentBetsEl.innerHTML = '';
      const arr = bets.slice(0,5);
      arr.forEach(b => {
        const el = document.createElement('div'); el.className = 'flex justify-between items-center';
        el.innerHTML = `<div><div class="font-semibold">${escapeHtml(b.description||'')}</div><div class="small">${b.platform || ''} • ${(b.date||'').slice(0,10)}</div></div><div class="font-semibold">${b.amount}₺</div>`;
        recentBetsEl.appendChild(el);
      });
    }

    function updateAllStatsAndUI() {
      totalBetsCount.innerText = `Bahis: ${bets.length}`;
      renderRecentBets();
      renderHistory();
      renderCashHistory();
      renderCustomPlatformsList();
      updateCharts();
      // stats
      const resolved = bets.filter(b => b.status === 'won' || b.status === 'lost');
      const wins = resolved.filter(b => b.status === 'won').length;
      const winRate = resolved.length ? Math.round((wins/resolved.length)*100) : 0;
      document.getElementById('stats-total-bets').innerText = bets.length;
      document.getElementById('stats-win-rate').innerText = `${winRate}%`;
      // ROI approximated
      const totalInvestment = bets.reduce((acc,v)=> acc + (+v.amount||0), 0);
      const netProfit = resolved.reduce((acc,v) => {
        if (v.status === 'won') {
          const win = v.win_amount !== undefined ? +v.win_amount : (+v.amount * ((+v.odds||1)-1));
          return acc + win;
        } else return acc - (+v.amount||0);
      }, 0);
      const roi = totalInvestment ? Math.round((netProfit/totalInvestment)*100) : 0;
      document.getElementById('stats-roi').innerText = `${roi}%`;
      // bankroll badge is already updated in renderCashHistory
    }

    // ---------- IMAGE UPLOAD & ANALYZE ----------
    let currentImageBase64 = null;
    imageSelectBtn.addEventListener('click', () => imageInput.click());
    imageInput.addEventListener('change', async (e) => {
      const f = e.target.files[0];
      if (!f) return;
      const base64 = await fileToBase64(f);
      previewImg.src = base64;
      imagePreview.classList.remove('hidden');
      currentImageBase64 = base64;
      geminiBtn.disabled = false;
    });

    removeImageBtn.addEventListener('click', () => {
      previewImg.src = '';
      imagePreview.classList.add('hidden');
      currentImageBase64 = null;
      geminiBtn.disabled = true;
    });

    // Paste support (Ctrl+V)
    document.addEventListener('paste', (e) => {
      const items = e.clipboardData && e.clipboardData.items;
      if (!items) return;
      for (const item of items) {
        if (item.type.indexOf('image') !== -1) {
          const blob = item.getAsFile();
          const fr = new FileReader();
          fr.onload = function(ev) {
            previewImg.src = ev.target.result;
            imagePreview.classList.remove('hidden');
            currentImageBase64 = ev.target.result;
            geminiBtn.disabled = false;
          };
          fr.readAsDataURL(blob);
        }
      }
    });

    geminiBtn.addEventListener('click', async () => {
      if (!currentImageBase64) return showNotification('Önce resim ekle', 'error');
      geminiBtn.disabled = true;
      geminiBtn.innerText = 'Analiz ediliyor...';
      try {
        // POST to your analyze endpoint (assumed /api/analyze)
        const res = await fetch('/api/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: currentImageBase64 })
        });
        if (!res.ok) throw new Error('Analiz endpoint yanıt vermedi: ' + res.status);
        const json = await res.json();
        // show analysis in ai-analysis-container (simple alert or notification)
        showNotification('Analiz tamamlandı: ' + (json.summary || '—'), 'success', 7000);
      } catch (err) {
        console.error(err);
        showNotification('Analiz hatası: ' + (err.message||err), 'error', 7000);
      } finally {
        geminiBtn.disabled = false;
        geminiBtn.innerText = '✨ Kuponu Oku & Analiz Et';
      }
    });

    async function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // ---------- UTIL ----------
    function escapeHtml(unsafe) {
      return (unsafe+'').replace(/[&<>"'`=\/]/g, function(s) {
        return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[s] || s);
      });
    }

    // ---------- BINDINGS (one-time) ----------
    let bound = false;
    function setupEventBindings() {
      if (bound) return;
      bound = true;

      // quick UI controls
      document.getElementById('platform-manager-btn').addEventListener('click', () => showSection('settings'));
      document.getElementById('reset-form-btn').addEventListener('click', () => betForm.reset());

      // history clear all
      document.getElementById('clear-all-btn').addEventListener('click', async () => {
        if (!confirm('Tüm bahis verilerini (bets) silmek istediğine emin misin?')) return;
        const { error } = await supabase.from('bets').delete().neq('id', 0);
        if (error) { showNotification('Silme hatası: ' + error.message, 'error'); return; }
        await loadBets(); updateAllStatsAndUI();
        showNotification('Tüm bahisler silindi', 'success');
      });

      // quick-add floating or similar not included; but keep other bindings already set.

      // status filter changes handled earlier
    }

    // ---------- START ----------
    await checkUser(); // triggers initApp if logged in

    // Expose some helpers in window for debugging (optional)
    window.__kasamatik = {
      supabase, loadBets, loadPlatforms, updateCharts, getState: () => ({ bets, platforms, cashHistory })
    };

  })();
  </script>
</body>
</html>
